<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Run CI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f9fafb;
      --card-bg: #fff;
      --text: #111827;
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #22c55e;
      --failure: #ef4444;
      --warning: #f59e0b;
      --muted: #6b7280;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 32px;
      color: var(--text);
    }
    h1 { text-align: center; font-size: 1.8rem; margin-bottom: 24px; color: var(--primary); }
    .container { max-width: 1100px; margin: auto; display: grid; gap: 24px; }
    .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px;
      padding: 12px 20px; border-radius: var(--radius);
      background: var(--primary); color: #fff; border: 0; cursor: pointer; font-weight: 500;
    }
    .btn[disabled] { background: var(--muted); cursor: not-allowed; }
    .status-graph { display: flex; gap: 20px; flex-wrap: wrap; }
    .status-card { flex: 1; min-width: 260px; }
    #status-box {
      border-radius: var(--radius); border: 1px solid #37415133;
      background: var(--bg); padding: 14px; font-size: 0.95rem; min-height: 120px;
    }
    .spinner {
      display: inline-block; width: 18px; height: 18px;
      border: 3px solid #e5e7eb; border-top: 3px solid var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    table {
      width: 100%; border-collapse: collapse; margin-top: 14px;
      border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); background: var(--card-bg);
    }
    th, td { padding: 10px 12px; text-align: left; font-size: 0.9rem; }
    th { background: #f3f4f6; font-weight: 600; color: #374151; }
    tr.success { background-color: #ecfdf5; }
    tr.failure { background-color: #fef2f2; }
    tr.running { background-color: #fffbeb; }
    tr.other   { background-color: #f9fafb; }
    tr:hover { background-color: #dbeafe; cursor: pointer; }
    tr.highlight { outline: 2px solid var(--primary); box-shadow: 0 0 6px var(--primary); }
    .chart-wrapper { flex: 1; min-width: 220px; display: flex; justify-content: center; align-items: center; }
    .chart-wrapper canvas { max-width: 220px; max-height: 220px; }
    select {
      padding: 8px;
      border-radius: var(--radius);
      border: 1px solid #ccc;
      margin-top: 8px;
      width: 100%;
      max-width: 400px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>

<body>
  <h1>üöÄ Run GitHub Workflow</h1>
  <div class="container">

    <div class="card">
      <label for="specSelect"><b>Select what to run:</b></label><br />
      <select id="specSelect">
        <option value="all">‚ú® Run All Tests</option>

        <optgroup label="1-getting-started">
          <option value="cypress/e2e/1-getting-started/todo.cy.js">todo.cy.js</option>
        </optgroup>

        <optgroup label="2-advanced-examples">
          <option value="cypress/e2e/2-advanced-examples/actions.cy.js">actions.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/aliasing.cy.js">aliasing.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/assertions.cy.js">assertions.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/connectors.cy.js">connectors.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/cookies.cy.js">cookies.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/cypress_api.cy.js">cypress_api.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/files.cy.js">files.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/location.cy.js">location.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/misc.cy.js">misc.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/navigation.cy.js">navigation.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/network_requests.cy.js">network_requests.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/querying.cy.js">querying.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/spies_stubs_clocks.cy.js">spies_stubs_clocks.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/storage.cy.js">storage.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/traversal.cy.js">traversal.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/utilities.cy.js">utilities.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/viewport.cy.js">viewport.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/waiting.cy.js">waiting.cy.js</option>
          <option value="cypress/e2e/2-advanced-examples/window.cy.js">window.cy.js</option>
        </optgroup>
      </select>
      <br /><br />
      <button id="run" class="btn">‚ñ∂ Run Workflow</button>
    </div>

    <div class="card status-graph">
      <div class="status-card">
        <h2>Triggered Workflow Status</h2>
        <div id="status-box">No workflow triggered yet.</div>
      </div>
      <div class="chart-wrapper">
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>Run History</h2>
      <table id="history-table">
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Spec</th>
            <th>Status</th>
            <th>Conclusion</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script>
    let currentRunId = null;
    let lastKnownRunId = null;
    let chartInstance = null;
    let statusFrozen = false;
    let triggeredSpec = "all";

    async function captureLastRunId() {
      try {
        const r = await fetch("https://pages-test-sooty.vercel.app/api/history");
        const data = await r.json();
        if (r.ok && data.runs.length > 0) {
          lastKnownRunId = data.runs[0].id;
        }
      } catch (err) {
        console.error("Could not capture last run ID:", err.message);
      }
    }

    async function dispatch() {
      await captureLastRunId();
      statusFrozen = false;

      triggeredSpec = document.getElementById("specSelect").value;
      const runButton = document.getElementById("run");

      // Disable button + show spinner
      runButton.disabled = true;
      runButton.innerHTML = `<span class="spinner"></span> Running...`;

      const body = {
        spec: triggeredSpec,
        message: triggeredSpec === "all"
          ? "Triggered full test suite"
          : `Triggered ${triggeredSpec}`
      };

      try {
        const r = await fetch("https://pages-test-sooty.vercel.app/api/trigger", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (r.ok) {
          const label = triggeredSpec === "all" ? "‚ú® All Tests" : triggeredSpec.split("/").pop();
          document.getElementById("status-box").innerHTML =
            `<p><span class="spinner"></span> Waiting for new run (<b>${label}</b>)...</p>`;
          waitForNextRun();
        } else {
          const data = await r.json();
          document.getElementById("status-box").innerHTML =
            `<p style="color:red;">‚ùå ${r.status}: ${data.error || "Unknown error"}</p>`;
        }
      } catch (err) {
        document.getElementById("status-box").innerHTML =
          `<p style="color:red;">‚ö†Ô∏è ${err.message}</p>`;
      } finally {
        // Restore button
        runButton.disabled = false;
        runButton.innerHTML = "‚ñ∂ Run Workflow";
      }
    }

    async function waitForNextRun() {
      if (statusFrozen) return;

      try {
        const r = await fetch("https://pages-test-sooty.vercel.app/api/history");
        const data = await r.json();
        const runs = data.runs || [];
        const newRun = runs.find(run => !lastKnownRunId || run.id > lastKnownRunId);

        if (newRun) {
          currentRunId = newRun.id;
          trackTriggeredRun(newRun);
        } else {
          setTimeout(waitForNextRun, 3000);
        }
      } catch (err) {
        console.error("Error waiting for next run:", err.message);
        setTimeout(waitForNextRun, 3000);
      }
    }

    async function trackTriggeredRun(run) {
      if (statusFrozen) return;

      const box = document.getElementById("status-box");
      const label = triggeredSpec === "all" ? "‚ú® All Tests" : triggeredSpec.split("/").pop();

      if (run.status === "queued" || run.status === "in_progress") {
        box.innerHTML = `
          <p><span class="spinner"></span><b>${run.name || "GitHub Workflow"} ‚Äì ${label}</b></p>
          <p>Run ID: ${run.id}</p>
          <p>Status: ${run.status}</p>
          <p>Conclusion: pending</p>
          <p><a href="${run.url}" target="_blank">üîó View on GitHub</a></p>
        `;
        setTimeout(() => refreshRun(run.id), 5000);
      } else {
        const icon = run.conclusion === "success" ? "‚úÖ" : "‚ùå";
        box.innerHTML = `
          <p>${icon} <b>${run.name || "GitHub Workflow"} ‚Äì ${label}</b></p>
          <p>Run ID: ${run.id}</p>
          <p>Status: ${run.status}</p>
          <p>Conclusion: ${run.conclusion}</p>
          <p><a href="${run.url}" target="_blank">üîó View on GitHub</a></p>
        `;
        currentRunId = null;
        statusFrozen = true;
      }
    }

    async function refreshRun(runId) {
      if (statusFrozen) return;
      try {
        const r = await fetch("https://pages-test-sooty.vercel.app/api/history");
        const data = await r.json();
        const run = (data.runs || []).find(r => String(r.id) === String(runId));
        if (run) trackTriggeredRun(run);
      } catch (err) {
        console.error("Error refreshing run:", err.message);
      }
    }

    async function updateHistoryFromServer() {
      try {
        const r = await fetch("https://pages-test-sooty.vercel.app/api/history");
        const data = await r.json();
        if (r.ok) {
          renderHistory(data.runs);
          updateChart(data.runs);
        }
      } catch (err) {
        console.error("History update failed:", err.message);
      }
    }

    function renderHistory(runs) {
      const tbody = document.querySelector("#history-table tbody");
      tbody.innerHTML = runs.map(run => {
        let cls = "other";
        if (run.status === "in_progress" || run.status === "queued") cls = "running";
        if (run.conclusion === "success") cls = "success";
        if (run.conclusion === "failure") cls = "failure";
        if (String(run.id) === String(currentRunId)) cls += " highlight";

        // ‚úÖ Show spec name nicely
        let specLabel = "‚ú® All Tests";
        if (run.message) {
          if (run.message.includes("cypress/")) {
            const fullPath = run.message.replace("Triggered ", "");
            specLabel = fullPath.split("/").pop(); // only filename
          } else if (run.message.includes("full test suite")) {
            specLabel = "‚ú® All Tests";
          }
        }

        return `
          <tr class="${cls}" data-id="${run.id}">
            <td>${run.id}</td>
            <td>${specLabel}</td>
            <td>${run.status}</td>
            <td>${run.conclusion || "pending"}</td>
            <td><a href="${run.url}" target="_blank">üîó View</a></td>
          </tr>
        `;
      }).join("");
    }

    function updateChart(runs) {
      const counts = { success: 0, failure: 0, running: 0, other: 0 };
      runs.forEach(run => {
        if (run.conclusion === "success") counts.success++;
        else if (run.conclusion === "failure") counts.failure++;
        else if (run.status === "in_progress" || run.status === "queued") counts.running++;
        else counts.other++;
      });

      const total = counts.success + counts.failure + counts.running + counts.other;
      const ctx = document.getElementById("statusChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Success", "Failure", "Running", "Other"],
          datasets: [{
            data: [counts.success, counts.failure, counts.running, counts.other],
            backgroundColor: ["#22c55e", "#ef4444", "#f59e0b", "#6b7280"]
          }]
        },
        options: {
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.raw;
                  const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${context.label}: ${value} (${percent}%)`;
                }
              }
            },
            datalabels: {
              color: "#fff",
              formatter: (value) => {
                const percent = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                return value > 0 ? `${percent}%` : "";
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    document.getElementById("run").addEventListener("click", dispatch);

    setInterval(updateHistoryFromServer, 15000);
    updateHistoryFromServer();
  </script>
</body>
</html>
